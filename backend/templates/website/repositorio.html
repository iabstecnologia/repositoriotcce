{% extends "base/base.html" %}
{% load static %}

{% block title %}Página Inicial - Repositório TCCEs{% endblock title %}

{% block extra_css %}
<style>
/* Estilos específicos da página de repositório */
.advanced-search-link {
    cursor: pointer;
    color: #ffffff;
    text-decoration: none;
}

/* Estilos de Botão de Filtro (search-filter-button) */
.search-filter-button {
    /* Define cores específicas para este componente (não estão no commons) */
    background-color: #F4F4F4;
    border-color: #F4F4F4;
    color: #333;

    /* Correção: Redução máxima de padding para diminuir o botão */
    padding: 2px 4px !important;
    line-height: 1;
}

.search-filter-button:hover {
    background-color: #e0e0e0;
    border-color: #e0e0e0;
    color: #333;
}

/* 1. Estilo para o Botão ATIVO (Dropdown ABERTO) */
/* Quando o dropdown está aberto, o Bootstrap define aria-expanded="true" no botão. */
.search-filter-button[aria-expanded="true"] {
    background-color: #e0e0e0; /* Exemplo: Fundo azul para indicar que está ativo */
    color: #333;              /* Exemplo: Cor da fonte branca */
    border-color: #333;     /* Exemplo: Borda azul */
}

/* 3. Estilo para o estado FOCADO (Após clicar ou navegar via teclado) */
.search-filter-button:focus {
    /* Mantenha o estilo ativo ou remova o box-shadow padrão do Bootstrap */
    box-shadow: 0 0 0 0.25rem rgba(51, 51, 51, 0.5);
    outline: none;
}

/* Correção: Seta SVG e anulação do caret do Bootstrap */
.search-filter-button.dropdown-toggle::after {
    /* Anula o triângulo do Bootstrap */
    border: none !important;

    /* Injeta o SVG customizado */
    content: url('/repositorio/assets/seta-baixo.svg');

    /* Ajustes de alinhamento e espaçamento */
    vertical-align: 0;
    margin-left: 0.5em;
}

.dropdown-menu-custom {
    background-color: #F4F4F4;
}

/* Estilos de Card de Categoria */
.categories-section {
    margin-top: -120px;
    position: relative;
    z-index: 2;
    padding-top: 1rem;
    padding-bottom: 1rem;
}

.categories-title {
    margin-bottom: 10px;
    position: relative;
    z-index: 2;
}

.category-card {
    min-width: 120px;
    max-width: 140px;
    min-height: 120px;
    overflow: hidden;
}

.category-icon-container {
    max-width: 80px;
    margin: 0 auto;
}

.submission-icon {
    width: 100%;
    max-width: 62px;
    height: auto;
}

/* Estilos de Botões de Ação no Card */
.share-btn, .view-btn, .download-btn {
    position: relative;
    z-index: 3;
    width: 2rem;
    height: 2rem;
    padding: 0;
    transition: filter 0.2s ease-in-out;
}

.view-btn:hover,
.share-btn:hover,
.download-btn:hover {
    background-color: #2a5229;
}

.view-icon, .share-icon, .download-icon {
    width: 50%;
    height: auto;
}

/* Estilos de Hover do Card (Overlay) */
.card-item-hoverable {
    position: relative;
    cursor: pointer;
}

.card-item-hoverable::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(100, 100, 100, 0);
    z-index: 10;
    transition: background-color 0.3s ease;
    pointer-events: none;
}

.card-item-hoverable .col-auto:last-child {
    position: relative;
    z-index: 11;
}

.card-item-hoverable:hover::before {
    background-color: #f4f4f4d5;
}

/* Estilos de Tag (Badges) */
.text-bg-ciencia {
    background-color: #A7674C;
    color: #ffffff;
}

.text-bg-ciencia:hover {
    background-color: #8c553d;
}

.text-bg-projeto {
    background-color: #55616C;
    color: #ffffff;
}

.text-bg-projeto:hover {
    background-color: #434e57;
    color: #ffffff;
}

.text-bg-ano {
    background-color: #346933;
    color: #ffffff;
}

.text-bg-ano:hover {
    background-color: #254d24;
    color: #ffffff;
}

.text-bg-publicacao {
    background-color: #5C9541;
    color: #ffffff;
}

.text-bg-publicacao:hover {
    background-color: #4b7835;
    color: #ffffff;
}

/* Estilos de Itens no Dropdown */
.form-check-label {
    width: 100%;
}

.checkbox-item {
    margin-bottom: 5px;
}

.checkbox-count {
    background-color: #a7674c;
    border-radius: 7px;
}
</style>
{% endblock extra_css %}

{% block hero_title %}
    Repositório TCCEs
{% endblock hero_title %}

{% block hero_content %}
<!-- Input Search -->
<div class="mt-1 col-10 col-sm-8 col-md-6 col-lg-4">
    <div class="input-group shadow-custom rounded-3">
        <span class="input-group-text bg-white border-0 rounded-start-3">
            <img src="{% static 'assets/11-1144.svg' %}" alt="Search icon" />
        </span>
        <input type="text" class="form-control border-0 font-open-sans" id="searchInput" placeholder="Buscar no repositório...">
        <button class="btn btn-success rounded-end-3 d-flex align-items-center justify-content-center p-0 px-3" id="searchButton" type="button">
            <img src="{% static 'assets/chevron-right.svg' %}" alt="Buscar" />
        </button>
    </div>
    <div class="mt-1 position-relative">
        <!-- Advanced Search Link / Button -->
        <div class="text-end text-white font-open-sans fw-bold text-decoration-none small">
            <a class="advanced-search-link" onclick="toggleAdvancedSearch(); return false;">BUSCA AVANÇADA &gt;</a>
        </div>

        <!-- Advanced Search Container -->
        <div class="filter-wrapper advanced-search-container d-none d-flex justify-content-center" id="advancedSearchContainer">
            <!-- Tema Filter -->
            <div class="filter-wrapper">
                <button class="btn search-filter-button dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-offset="0,10">
                    Tema
                </button>
                <div class="dropdown-menu-custom dropdown-menu w-auto" id="temaDropdown">
                    <div class="p-2">
                        <div class="checkbox-item form-check">
                            <input class="form-check-input filter-checkbox" type="checkbox" id="tema-biologia-1" value="Biologia" data-filter-type="tema">
                            <label class="form-check-label d-flex justify-content-between align-items-center" for="tema-biologia-1">
                                <span>Biologia</span>
                                <span class="badge checkbox-count ms-3">15</span>
                            </label>
                        </div>

                        <div class="checkbox-item form-check">
                            <input class="form-check-input filter-checkbox" type="checkbox" id="tema-biologia-2" value="Biologia" data-filter-type="tema">
                            <label class="form-check-label d-flex justify-content-between align-items-center" for="tema-biologia-2">
                                <span>Biologia Celular e Molecular</span>
                                <span class="badge checkbox-count ms-3">150</span>
                            </label>
                        </div>

                        <div class="checkbox-item form-check">
                            <input class="form-check-input filter-checkbox" type="checkbox" id="tema-biologia-3" value="Biologia" >
                            <label class="form-check-label d-flex justify-content-between align-items-center" for="tema-biologia-3">
                                <span>Ecologia e Meio Ambiente</span>
                                <span class="badge checkbox-count ms-3">5</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tipo Filter -->
            <div class="filter-wrapper">
                <button class="btn search-filter-button dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-offset="0,10">
                    Tipo
                </button>
                <div class="dropdown-menu-custom dropdown-menu w-auto" id="temaDropdown">
                    <div class="p-2">
                        <div class="checkbox-item form-check">
                            <input class="form-check-input filter-checkbox" type="checkbox" id="tema-tipo-1" value="Tipo" data-filter-type="tipo">
                            <label class="form-check-label d-flex justify-content-between align-items-center" for="tema-tipo-1">
                                <span>Revista</span>
                                <span class="badge checkbox-count ms-3">15</span>
                            </label>
                        </div>

                        <div class="checkbox-item form-check">
                            <input class="form-check-input filter-checkbox" type="checkbox" id="tema-tipo-2" value="Tipo" data-filter-type="tipo">
                            <label class="form-check-label d-flex justify-content-between align-items-center" for="tema-tipo-2">
                                <span>Artigo Científico</span>
                                <span class="badge checkbox-count ms-3">150</span>
                            </label>
                        </div>

                        <div class="checkbox-item form-check">
                            <input class="form-check-input filter-checkbox" type="checkbox" id="tema-tipo-3" value="Tipo" data-filter-type="tipo">
                            <label class="form-check-label d-flex justify-content-between align-items-center" for="tema-tipo-3">
                                <span>Gibis</span>
                                <span class="badge checkbox-count ms-3">5</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Região Filter -->
            <div class="filter-wrapper">
                <button class="btn search-filter-button dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-offset="0,10">
                    Região
                </button>
                <div class="dropdown-menu-custom dropdown-menu w-auto" id="temaDropdown">
                    <div class="p-2">
                        <div class="checkbox-item form-check">
                            <input class="form-check-input filter-checkbox" type="checkbox" id="tema-regiao-1" value="Regiao" data-filter-type="regiao">
                            <label class="form-check-label d-flex justify-content-between align-items-center" for="tema-regiao-1">
                                <span>Centro-Oeste</span>
                                <span class="badge checkbox-count ms-3">15</span>
                            </label>
                        </div>

                        <div class="checkbox-item form-check">
                            <input class="form-check-input filter-checkbox" type="checkbox" id="tema-regiao-2" value="Regiao" data-filter-type="regiao">
                            <label class="form-check-label d-flex justify-content-between align-items-center" for="tema-regiao-2">
                                <span>Nordeste</span>
                                <span class="badge checkbox-count ms-3">150</span>
                            </label>
                        </div>

                        <div class="checkbox-item form-check">
                            <input class="form-check-input filter-checkbox" type="checkbox" id="tema-regiao-3" value="Regiao" data-filter-type="regiao">
                            <label class="form-check-label d-flex justify-content-between align-items-center" for="tema-regiao-3">
                                <span>Sul</span>
                                <span class="badge checkbox-count ms-3">5</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ano Filter -->
            <div class="filter-wrapper">
                <button class="btn search-filter-button dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-offset="0,10">
                    Ano
                </button>
                <div class="dropdown-menu-custom dropdown-menu w-auto" id="temaDropdown">
                    <div class="p-2">
                        <div class="checkbox-item form-check">
                            <input class="form-check-input filter-checkbox" type="checkbox" id="tema-ano-1" value="Ano" data-filter-type="ano">
                            <label class="form-check-label d-flex justify-content-between align-items-center" for="tema-ano-1">
                                <span>2021</span>
                                <span class="badge checkbox-count ms-3">15</span>
                            </label>
                        </div>

                        <div class="checkbox-item form-check">
                            <input class="form-check-input filter-checkbox" type="checkbox" id="tema-ano-2" value="Ano" data-filter-type="ano">
                            <label class="form-check-label d-flex justify-content-between align-items-center" for="tema-ano-2">
                                <span>2022</span>
                                <span class="badge checkbox-count ms-3">150</span>
                            </label>
                        </div>

                        <div class="checkbox-item form-check">
                            <input class="form-check-input filter-checkbox" type="checkbox" id="tema-ano-3" value="Ano" data-filter-type="ano">
                            <label class="form-check-label d-flex justify-content-between align-items-center" for="tema-ano-3">
                                <span>2023</span>
                                <span class="badge checkbox-count ms-3">5</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock hero_content %}

{% block content %}

<!-- Categories Section -->
<div class="container categories-section">
    <div class="categories-title">
        <h2 class="text-white font-open-sans fw-bolder fs-6 text-center">PRINCIPAIS CATEGORIAS</h2>
    </div>
    <div class="row d-grip justify-content-center text-center gap-4 px-3 px-sm-4 px-md-5">
        <a href="#" class="card category-card category-link text-decoration-none border-0 rounded-4 bg-custom-light-gray" data-category-name="Livros">
            <div class="card-body p-3 d-flex flex-column justify-content-center align-items-center">
                <div class="category-icon-container">
                    <img src="{% static 'assets/11-1149.svg' %}" alt="Livros" class="img-fluid" />
                </div>
                <p class="card-text mt-3 mb-0 text-custom-dark font-open-sans fw-medium category-text">Livros</p>
            </div>
        </a>

        <a href="#" class="card category-card category-link text-decoration-none border-0 rounded-4 bg-custom-light-gray" data-category-name="Artigos">
            <div class="card-body p-3 d-flex flex-column justify-content-center align-items-center">
                <div class="category-icon-container">
                    <img src="{% static 'assets/11-1288.svg' %}" alt="Artigos" class="img-fluid" />
                </div>
                <p class="card-text mt-3 mb-0 text-custom-dark font-open-sans fw-medium category-text">Artigos</p>
            </div>
        </a>

        <a href="#" class="card category-card category-link text-decoration-none border-0 rounded-4 bg-custom-light-gray" data-category-name="Revistas">
            <div class="card-body p-3 d-flex flex-column justify-content-center align-items-center">
                <div class="category-icon-container">
                    <img src="{% static 'assets/11-1294.svg' %}" alt="Revistas" class="img-fluid" />
                </div>
                <p class="card-text mt-3 mb-0 text-custom-dark font-open-sans fw-medium category-text">Revistas</p>
            </div>
        </a>

        <a href="#" class="card category-card category-link text-decoration-none border-0 rounded-4 bg-custom-light-gray" data-category-name="Vídeos">
            <div class="card-body p-3 d-flex flex-column justify-content-center align-items-center">
                <div class="category-icon-container">
                    <img src="{% static 'assets/11-1304.svg' %}" alt="Vídeos" class="img-fluid" />
                </div>
                <p class="card-text mt-3 mb-0 text-custom-dark font-open-sans fw-medium category-text">Vídeos</p>
            </div>
        </a>
    </div>
</div>

<!-- Recent Submissions Section -->
<div class="container py-5">
    <h2 class="text-center text-custom-dark font-open-sans fw-medium mb-5 h1" id="submissionsTitle">Submissões Recentes</h2>

    <div class="row justify-content-center">
        <div class="col-lg-8" id="submissionsContainer">
            <!-- Mensagem quando não há submissões -->
            {% if not submissoes %}
                <div class="alert alert-info text-center">
                    <p class="mb-0">Nenhuma submissão encontrada no momento.</p>
                </div>
            {% else %}
                <!-- Loop através das submissões -->
                {% for submissao in submissoes %}
                    <div class="card border-0 card-item-hoverable">
                        <div class="row g-0 align-items-center py-3 border-bottom border-secondary-subtle p-4">
                            <div class="col-auto">
                                <img src="{% static 'assets/198-196.svg' %}" alt="File icon" class="submission-icon" />
                            </div>
                            <div class="col ps-3">
                                <p class="mb-0 text-custom-dark font-open-sans fw-medium small">
                                    <strong>{{ submissao.titulo }}</strong> - 
                                    {% for autor in submissao.autores.all %}
                                        {{ autor.nome }}{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                    <br/>
                                    {{ submissao.data_publicacao|date:"d/m/Y" }}
                                </p>
                                <div class="d-flex flex-wrap gap-2 mt-2">
                                    <span class="badge rounded-pill text-bg-ciencia small">{{ submissao.area_tematica.nome }}</span>
                                    <span class="badge rounded-pill text-bg-projeto small">{{ submissao.tipo_documento.nome }}</span>
                                    <span class="badge rounded-pill text-bg-publicacao small">{{ submissao.tipo_publicacao.nome }}</span>
                                </div>
                            </div>
                            <div class="col-auto d-flex flex-column flex-md-row gap-2">
                                {% if submissao.arquivo %}
                                    <a href="{{ submissao.arquivo.url }}" class="btn btn-sm bg-custom-green text-white rounded-circle d-flex align-items-center justify-content-center view-btn" title="Visualizar">
                                        <img src="{% static 'assets/198-300.svg' %}" alt="Visualizar icon" class="view-icon" />
                                    </a>
                                {% endif %}
                                <button class="btn btn-sm bg-custom-green text-white rounded-circle d-flex align-items-center justify-content-center share-btn" title="Compartilhar">
                                    <img src="{% static 'assets/198-296.svg' %}" alt="Compartilhar icon" class="share-icon" />
                                </button>
                                {% if submissao.arquivo %}
                                    <a href="{{ submissao.arquivo.url }}" download class="btn btn-sm bg-custom-green text-white rounded-circle d-flex align-items-center justify-content-center download-btn" title="Download">
                                        <img src="{% static 'assets/198-292.svg' %}" alt="Download icon" class="download-icon" />
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
        <div class="d-flex justify-content-center mt-5">
            <nav aria-label="Page navigation">
                <ul class="pagination flex-wrap justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link pagination-circle bg-secondary mx-2 pagination-prev" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                                <span aria-hidden="true" class="text-white">&lt;</span>
                            </a>
                        </li>
                    {% endif %}

                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link pagination-circle bg-secondary text-white mx-1" href="?page=1">1</a>
                        </li>
                        {% if page_obj.previous_page_number != 1 %}
                            <li class="page-item">
                                <a class="page-link pagination-circle bg-secondary text-white mx-1" href="?page={{ page_obj.previous_page_number }}">{{ page_obj.previous_page_number }}</a>
                            </li>
                        {% endif %}
                    {% endif %}
                    
                    <li class="page-item active">
                        <span class="page-link pagination-circle bg-custom-green text-white mx-1">{{ page_obj.number }}</span>
                    </li>
                    
                    {% if page_obj.has_next %}
                        {% if page_obj.next_page_number != page_obj.paginator.num_pages %}
                            <li class="page-item">
                                <a class="page-link pagination-circle bg-secondary text-white mx-1" href="?page={{ page_obj.next_page_number }}">{{ page_obj.next_page_number }}</a>
                            </li>
                        {% endif %}
                        <li class="page-item">
                            <a class="page-link pagination-circle bg-secondary text-white mx-1" href="?page={{ page_obj.paginator.num_pages }}">{{ page_obj.paginator.num_pages }}</a>
                        </li>
                    {% endif %}

                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link pagination-circle bg-secondary mx-2 pagination-next" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                                <span aria-hidden="true" class="text-white">&gt;</span>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    {% endif %}
</div>

{% endblock content %}

{% block extra_js %}
<script>
// ===============================================
// MÓDULO 1: Funções de Lógica (Visibilidade e Estado)
// ===============================================

/**
 * Alterna a exibição/ocultação do container de busca avançada e do link.
 * O container usa 'd-none' para remover do fluxo. O link usa 'invisible' para manter o espaço.
 */
function toggleAdvancedSearch() {
    const advancedSearchContainer = document.getElementById('advancedSearchContainer');
    const advancedSearchLink = document.querySelector('.advanced-search-link');
    const categoriesSection = document.querySelector('.categories-section');
    const heroSection = document.querySelector('.hero-section');

    if (!advancedSearchContainer || !advancedSearchLink) return;

    // Alterna a visibilidade dos elementos principais
    advancedSearchContainer.classList.toggle('d-none');
    advancedSearchLink.classList.toggle('invisible');
    categoriesSection.classList.toggle('d-none');
    heroSection.classList.toggle('z-3');
}

/**
 * Alterna a visibilidade de um dropdown de filtros customizado.
 * Fecha todos os outros dropdowns ativos.
 */
function toggleDropdown(event, dropdownId) {
    if (event) event.stopPropagation();
    const dropdown = document.getElementById(dropdownId);

    // Fechar todos os outros dropdowns
    document.querySelectorAll('.dropdown-menu-custom.active').forEach(menu => {
        if (menu.id !== dropdownId) {
            menu.classList.remove('active');
        }
    });

    // Alternar o dropdown atual
    if (dropdown) {
        dropdown.classList.toggle('active');
    }
}


// ===============================================
// MÓDULO 2: Funções de Eventos (Event Handlers e API)
// ===============================================

// Variável global para o estado de ordenação
let currentSortOrder = '-data_publicacao'; // Padrão: mais recente (o '-' indica decrescente no Django)

/**
 * Trata o clique em um link de categoria.
 * Define o nome da categoria como palavra-chave e título, e inicia a busca.
 */
function handleCategoryClick(event) {
    event.preventDefault(); // Impede o comportamento padrão do link

    // Pega o nome da categoria do atributo de dados
    const categoryName = event.currentTarget.getAttribute('data-category-name');

    if (!categoryName) return;

    // Salva o valor atual do campo de busca principal
    const originalSearchValue = searchInput ? searchInput.value : '';

    // 1. Temporariamente define o input de busca para que a função buildSearchQuery capture a categoria
    if (searchInput) {
        searchInput.value = categoryName;
    }

    // 2. Inicia a busca, passando o nome da categoria como título personalizado
    // A função filterAndFetchSubmissions agora cuidará do título e da requisição
    filterAndFetchSubmissions(categoryName);

    // 3. Restaura o valor original do input de busca imediatamente
    // Isso garante que o campo não fique preenchido com o nome da categoria.
    if (searchInput) {
        searchInput.value = originalSearchValue;
    }
}

// Variáveis globais para a busca
const API_BASE_URL = '/api/submissoes/';
const submissionsContainer = document.getElementById('submissionsContainer'); // ID do container onde os resultados são renderizados

/**
 * Constrói a URL de busca no backend com base no input principal e nos filtros avançados.
 * @returns {string} A URL completa para a chamada da API.
 */
function buildSearchQuery() {
    const params = new URLSearchParams();

    // 1. Termo de Busca Principal
    const searchInput = document.getElementById('searchInput');
    const searchTerm = searchInput ? searchInput.value.trim() : '';

    if (searchTerm) {
        params.append('search', searchTerm);
    }

    // 2. Coleta os valores dos filtros avançados
    const filters = {};
    const checkedCheckboxes = document.querySelectorAll('.filter-checkbox:checked');

    checkedCheckboxes.forEach(checkbox => {
        const type = checkbox.getAttribute('data-filter-type');
        const value = checkbox.value;

        if (type) {
            if (!filters[type]) {
                filters[type] = [];
            }
            filters[type].push(value);
        }
    });

    // 3. Adiciona os filtros à URL
    for (const type in filters) {
        // Envia os valores múltiplos como uma string separada por vírgula (Ex: tipo=Revista,Artigo)
        params.append(type, filters[type].join(','));
    }

    // 4. Adiciona o parâmetro de ordenação
    if (currentSortOrder) {
        params.append('ordering', currentSortOrder);
    }

    // Retorna a URL completa
    return `${API_BASE_URL}?${params.toString()}`;
}

/**
 * Cria o HTML para um único item de submissão.
 * @param {Object} item - Objeto de submissão retornado pela API.
 * @returns {string} O HTML formatado do item.
 */
function createSubmissionItemHTML(item) {
    // ATENÇÃO: Adapte os nomes de campo (item.title, item.author, item.badges, etc.)
    // para corresponderem exatamente à estrutura JSON que sua API Django irá retornar.

    const badgesHtml = item.badges.map(badge =>
        `<span class="badge rounded-pill text-bg-${badge.class} small">${badge.text}</span>`
    ).join('');

    return `
        <div class="card border-0 card-item-hoverable submission-item-content">
            <div class="row g-0 align-items-center py-3 border-bottom border-secondary-subtle p-4">
                <div class="col-auto">
                    <img src="${item.icon_url}" alt="File icon" class="submission-icon" />
                </div>
                <div class="col ps-3">
                    <p class="mb-0 text-custom-dark font-open-sans fw-medium small">${item.title} - ${item.author} <br/>${item.date}</p>
                    <div class="d-flex flex-wrap gap-2 mt-2">
                        ${badgesHtml}
                    </div>
                </div>
                <div class="col-auto d-flex flex-column flex-md-row gap-2">
                    <button class="btn btn-sm bg-custom-green text-white rounded-circle d-flex align-items-center justify-content-center view-btn" title="Visualizar"><i class="bi bi-eye"></i></button>
                    <button class="btn btn-sm bg-custom-green text-white rounded-circle d-flex align-items-center justify-content-center share-btn" title="Compartilhar"><i class="bi bi-share"></i></button>
                    <button class="btn btn-sm bg-custom-green text-white rounded-circle d-flex align-items-center justify-content-center download-btn" title="Download"><i class="bi bi-download"></i></button>
                </div>
            </div>
        </div>
    `;
}

/**
 * Função principal que constrói a URL e chama a API para filtrar as submissões.
 * @param {string | null} customTitle - Se fornecido, é o título que será exibido.
 */
async function filterAndFetchSubmissions(customTitle = null) {
    if (!submissionsContainer) {
        console.error("Elemento 'submissionsContainer' não encontrado.");
        return;
    }

    // Altera o título para "Resultado da Busca" ao iniciar a busca
    if (submissionsTitle) {
        submissionsTitle.textContent = customTitle || 'Resultado da Busca';
    }

    const url = buildSearchQuery();

    // Limpa e mostra feedback de carregamento
    submissionsContainer.innerHTML = '<p class="text-center p-5">Buscando resultados...</p>';

    try {
        const response = await fetch(url);

        if (!response.ok) {
            throw new Error(`Erro ao buscar dados: ${response.status} ${response.statusText}`);
        }

        // A API Django deve retornar um array de objetos JSON
        const submissions = await response.json();

        if (submissions.length === 0) {
            submissionsContainer.innerHTML = '<p class="text-center p-5">Nenhum item encontrado para os critérios selecionados.</p>';
        } else {
            // Gera o HTML e substitui o conteúdo
            const htmlContent = submissions.map(createSubmissionItemHTML).join('');
            submissionsContainer.innerHTML = htmlContent;
        }
    } catch (error) {
        console.error('Falha na requisição API:', error);
        submissionsContainer.innerHTML = '<p class="text-center p-5 text-danger">Falha ao conectar com o repositório de dados. Verifique o endpoint da API.</p>';
    }
}


// ===============================================
// MÓDULO 3: Inicialização (DOMContentLoaded)
// ===============================================

document.addEventListener('DOMContentLoaded', function() {

    // ----------------------------------------------------
    // INICIALIZAÇÃO DE EVENTOS DE CATEGORIA
    // ----------------------------------------------------
    const categoryLinks = document.querySelectorAll('.category-link');
    categoryLinks.forEach(link => {
        link.addEventListener('click', handleCategoryClick);
    });

    // ----------------------------------------------------
    // INICIALIZAÇÃO DE EVENTOS DE BUSCA E FILTRO (API)
    // ----------------------------------------------------

    // 1. Busca Principal (AGORA SÓ DISPARA NO CLIQUE DO BOTÃO)
    const searchButton = document.getElementById('searchButton');

    if (searchButton) {
        // Dispara a busca quando o botão é CLICADO
        // Usando uma arrow function para garantir que nenhum argumento seja passado.
        searchButton.addEventListener('click', () => filterAndFetchSubmissions());

        // Opcional: Disparar a busca ao pressionar ENTER no campo de busca
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    filterAndFetchSubmissions();
                }
            });
        }
    } else {
        console.error("Botão de busca não encontrado! Verifique o seletor.");
    }

    // 1.1 Busca Principal (Ao digitar, dispara a busca)
    // const searchInput = document.getElementById('searchInput'); // Usando o ID 'searchInput'
    // if (searchInput) {
    //     searchInput.addEventListener('input', filterAndFetchSubmissions);
    // }

    // 2. Filtros Avançados (Ao clicar em qualquer checkbox, dispara a busca)
    // ATENÇÃO: Este seletor depende que seus checkboxes tenham a classe 'filter-checkbox'
    const filterCheckboxes = document.querySelectorAll('.filter-checkbox');
    filterCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => filterAndFetchSubmissions());
    });

    // 3. Executa a busca inicial ao carregar a página (carrega todos os itens ou um conjunto padrão)
    // filterAndFetchSubmissions();

    // ----------------------------------------------------
    // INICIALIZAÇÃO DE EVENTOS DE ORDENAÇÃO
    // ----------------------------------------------------
    const sortOptions = document.querySelectorAll('.sort-option');
    const currentSortLabel = document.getElementById('currentSortLabel');

    sortOptions.forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();

            // 1. Atualiza o estado global de ordenação
            currentSortOrder = this.getAttribute('data-sort-by');

            // 2. Atualiza o texto do botão para feedback visual
            currentSortLabel.textContent = this.textContent;

            // 3. Dispara uma nova busca com o novo critério de ordenação
            filterAndFetchSubmissions();
        });
    });

    // ----------------------------------------------------
    // OUTROS EVENTOS E RESPONSIVIDADE
    // ----------------------------------------------------

    // Funcionalidade de compartilhamento
    document.querySelectorAll('.share-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Compartilhar clicado');
            // Lógica de compartilhamento deve ser implementada aqui
        });
    });
});

// Tornar as funções de toggle acessíveis globalmente, se usadas no HTML (onClick)
window.toggleAdvancedSearch = toggleAdvancedSearch;
window.toggleDropdown = toggleDropdown;
</script>
{% endblock extra_js %}